#!/bin/bash

# Triton-optimized Consul start script.

case "$1" in

    raft)
        # Start the bootstrap script and background it
        # the bootstrap will wait for Couchbase to start, then die when done
        /usr/local/bin/triton-bootstrap &

        CONSULSCRIPT=/bin/consul-start

        while [ ! -e CONSULSCRIPT ]
        do
            echo -n '.'
            sleep .7
        done

        # Start Couchbase
        CONSULSCRIPT
        ;;

    bootstrap)
        set -eo pipefail
        exec /bin/consul agent -config-dir=/config -server -bootstrap -ui-dir /ui
        ;;

    *)
        exec "$@"
        ;;
esac
