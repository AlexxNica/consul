#!/bin/bash

# Triton-optimized Consul start script.

case "$1" in

    #
    # This is the normal case for an HA raft of Consul instances
    #
    raft)
        # Start the bootstrap script and background it
        # the script will wait for for a raft to form, generate the command to start Consul, then exit
        /bin/triton-bootstrap &

        # wait for the execution command to be generated by the bootstrap script
        CONSULSCRIPT=/bin/consul-start-cmd
        while [ ! -e $CONSULSCRIPT ]
        do
            echo -n '.'
            sleep .7
        done

        # sleep another moment
        sleep .7

        # start the heartbeat script in the background
        /bin/consul-health &

        # Start Consul
        bash $CONSULSCRIPT

        # if Consul stops or fails, remove the config file before exiting the container
        rm $CONSULSCRIPT

        echo '#'
        echo '# Consul has stopped...'
        echo '#'
        ;;

    #
    # A special, non-HA case for bootstrapping the HA raft
    #
    bootstrap)
        set -eo pipefail
        /bin/consul agent -config-dir=/config -server -bootstrap -ui-dir /ui

        # We only get here if Consul stops or fails...
        echo '#'
        echo '# Consul has stopped...'
        echo '#'
        ;;

    #
    # The user wants to run something else...
    #
    *)
        exec "$@"
        ;;

esac
